apiVersion: v1
kind: Secret
metadata:
  name: grafana-values
type: Opaque
stringData:
  values.yaml: |-
    adminUser: admin
    adminPassword: "J&2E2qyXqNzzFUH4um2k"
    grafana.ini:
      server:
        root_url: https://grafana.${SECRET_DOMAIN}
        domain: grafana.${SECRET_DOMAIN}
      auth:
        disable_login_form: false
        oauth_auto_login: true
      auth.generic_oauth:
        enabled: true
        name: Authentik
        scopes: openid profile email
        email_attribute_name: email:primary
        login_attribute_path: preferred_username
        name_attribute_path: name
        # These will come from your Authentik OAuth2/OpenID provider for Grafana
        auth_url: https://auth.${SECRET_DOMAIN}/application/o/authorize/
        token_url: https://auth.${SECRET_DOMAIN}/application/o/token/
        api_url: https://auth.${SECRET_DOMAIN}/application/o/userinfo/
        allow_sign_up: true
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
          - name: Prometheus
            type: prometheus
            access: proxy
            url: http://kube-prometheus-stack-prometheus.monitoring.svc.cluster.local:9090
            isDefault: true
          - name: Loki
            type: loki
            access: proxy
            url: http://loki.monitoring.svc.cluster.local:3100
          - name: Tempo
            type: tempo
            access: proxy
            url: http://tempo.monitoring.svc.cluster.local:3200
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
          - name: 'default'
            orgId: 1
            folder: ''
            type: file
            disableDeletion: false
            updateIntervalSeconds: 10
            options:
              path: /var/lib/grafana/dashboards/default
    dashboards:
      default:
        kubernetes-events:
          json: |-
            {
              "id": null,
              "uid": "k8s-events",
              "title": "Kubernetes Events (Loki)",
              "tags": ["kubernetes","events","loki"],
              "timezone": "browser",
              "schemaVersion": 39,
              "version": 1,
              "refresh": "30s",
              "panels": [
                {
                  "type": "logs",
                  "title": "Recent Events",
                  "gridPos": { "x": 0, "y": 0, "w": 24, "h": 16 },
                  "options": {
                    "dedupStrategy": "none",
                    "enableLogDetails": true,
                    "showLabels": false,
                    "wrapLogMessage": true
                  },
                  "targets": [
                    {
                      "refId": "A",
                      "datasource": { "type": "loki", "uid": "Loki" },
                      "expr": "{job=\"kubernetes-event-exporter\"} | json"
                    }
                  ]
                }
              ]
            }
